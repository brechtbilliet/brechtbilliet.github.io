<!DOCTYPE html>
<html lang=" en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"/><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Thinking reactively in Angular and RXJS | Frontend software architect living in Belgium</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="Thinking reactively in Angular and RXJS" />
<meta name="author" content="brechtbilliet" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="RxJS is an awesome library that can help us with creating reactive web applications. Reactive web applications can be overwhelming in the beginning, but eventually, they can be really rewarding.This article is all about making the paradigm switch from thinking imperatively towards thinking reactively." />
<meta property="og:description" content="RxJS is an awesome library that can help us with creating reactive web applications. Reactive web applications can be overwhelming in the beginning, but eventually, they can be really rewarding.This article is all about making the paradigm switch from thinking imperatively towards thinking reactively." />
<link rel="canonical" href="https://blog.brecht.io/Creating-reactive-calendar-in-angular4/" />
<meta property="og:url" content="https://blog.brecht.io/Creating-reactive-calendar-in-angular4/" />
<meta property="og:site_name" content="Frontend software architect living in Belgium" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-07-25T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Thinking reactively in Angular and RXJS" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"brechtbilliet"},"dateModified":"2017-07-25T00:00:00+02:00","datePublished":"2017-07-25T00:00:00+02:00","description":"RxJS is an awesome library that can help us with creating reactive web applications. Reactive web applications can be overwhelming in the beginning, but eventually, they can be really rewarding.This article is all about making the paradigm switch from thinking imperatively towards thinking reactively.","headline":"Thinking reactively in Angular and RXJS","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.brecht.io/Creating-reactive-calendar-in-angular4/"},"url":"https://blog.brecht.io/Creating-reactive-calendar-in-angular4/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://blog.brecht.io/feed.xml" title="Frontend software architect living in Belgium" /></head>
<body>
<section class="app">
    <nav class="app__menu ">
        <button name="menu-button" class="app__menu-button" type="button"
        ><i class="fa-solid fa-bars"></i></button>
        <ul>
            <li>
                <div>
                    <a href="https://brecht.io/">
                        <i class="fa-brands fa-angular"></i>
                        <span class="app__menu-item-label">BRECHT</span>
                    </a>
                </div>
            </li>
            <li>
                <div>
                    <a href="https://brecht.io/hire-me">
                        <i class="fa-solid fa-person-walking"></i>
                        <span class="app__menu-item-label">HIRE ME</span>
                    </a>
                </div>
            </li>
            <li>
                <div>
                    <a href="https://brecht.io/happy-clients">
                        <i class="fa-solid fa-hand-holding-heart"></i>
                        <span class="app__menu-item-label">CLIENTS</span>
                    </a>
                </div>
            </li>
            <li>
                <div>
                    <a href="https://brecht.io/consultancy">
                        <i class="fa-solid fa-user-tie"></i>
                        <span class="app__menu-item-label">CONSULTANCY</span>
                    </a>
                </div>
            </li>
            <li>
                <div>
                    <a href="https://brecht.io/code-reviews">
                        <i class="fa-solid fa-laptop-code"></i>
                        <span class="app__menu-item-label">CODE REVIEWS</span>
                    </a>
                </div>
            </li>
            <li>
                <div>
                    <a href="https://brecht.io/">
                        <i class="fa-solid fa-school"></i>
                        <span class="app__menu-item-label">COACHING</span>
                    </a>
                </div>
            </li>
            <li>
                <div>
                    <a class="link--active" href="https://blog.brecht.io/">
                        <i class="fa-solid fa-blog"></i>
                        <span class="app__menu-item-label">BLOG</span>
                    </a>
                </div>
            </li>
            <li>
                <a href="https://brecht.io/contact">
                    <i class="fa-solid fa-envelope-open-text"></i>
                    <span class="app__menu-item-label">CONTACT</span>
                </a>
            </li>
        </ul>
    </nav>
    <div class="container-wrapper">
        <div class="container">
            <main class="page-content" aria-label="Content">
                <div class="wrapper">
                    <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Thinking reactively in Angular and RXJS</h1>
    <p class="post-meta">
      <img class="author-thumb" src="/assets/images/brecht.png" alt="Author image" nopin="nopin" />
      <time class="dt-published" datetime="2017-07-25T00:00:00+02:00" itemprop="datePublished">Jul 25, 2017
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">brechtbilliet</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="foreword">Foreword</h2>

<p>RxJS is an awesome library that can help us with creating <strong>reactive web applications</strong>. Reactive web applications can be overwhelming in the beginning, but eventually, they can be really rewarding.</p>

<p>This article is all about making the paradigm switch from thinking imperatively towards <strong>thinking reactively</strong>.
In this article, we will explain how to write a reactive calendar application in only a few lines of code (<strong>spoiler: It’s gonna be real time too</strong>).</p>

<p>We will use Angular, Angular Material, TypeScript, RxJS, Firebase, and AngularFire as our main technology stack. Keep in mind that this article really focusses on reactive programming. Don’t expect a deep dive into all RxJS operators, but rather expect an explanation of how to draw, think, and reason about reactive web applications. We will learn <strong>how to think in streams</strong>. If you haven’t heard of streams yet, please read <a href="https://gist.github.com/staltz/868e7e9bc2a7b8c1f754">this awesome article</a> first.</p>

<p><strong>Note:</strong> This article contains personal terminology.</p>

<h2 id="the-reactive-calendar">The Reactive Calendar</h2>
<p>This is the application we are going to write. It’s a small but complete calendar application that allows us to:</p>

<ul>
  <li>Switch between different view modes: day, week, month.</li>
  <li>Navigate to previous and next days, weeks, and months.</li>
  <li>Add, update, and remove appointments.</li>
  <li>Search for specific appointments.</li>
</ul>

<p><img src="https://raw.githubusercontent.com/brechtbilliet/brechtbilliet.github.io/master/_posts/reactivecalendar/reactivecalendar1.png" alt="Reactive calendar" /></p>

<p>The user can interact with the following UI elements:</p>

<ul>
  <li><strong>Next button:</strong> Allows the user to go to the next day in day mode, week in week mode, etc.</li>
  <li><strong>Previous button:</strong> Allows the user to go to the previous day in day mode, week in week mode, etc.</li>
  <li><strong>Day, week, month buttons:</strong> Allows the user to switch between the different view modes</li>
  <li><strong>Search term input:</strong> Allows the user to filter the appointments on the fly</li>
  <li><strong>Plus-buttons in the grid:</strong> Allows the user to create new appointments</li>
  <li><strong>Trashcan buttons in the grid:</strong> Allows the user to remove appointments</li>
  <li><strong>Description inputs:</strong> Allows the user to update the description of an appointment</li>
</ul>

<p>I decided to use Firebase as a backend and because of that, our application will be realtime and offline first by default!</p>

<p><strong>Note:</strong> One small issue, I’ve been a bit lazy so we can only create lunch appointments. =) But hey! Consider it some homework.</p>

<h2 id="setting-up-the-project">Setting Up the Project</h2>

<p>I’ve created the git branch <strong>initial</strong> to get us started. It contains the default logic/components, setup, and styles. There is no reactive code written yet, just plain Angular code. The goal is to write the reactive part ourselves.</p>

<h3 id="the-component-tree">The Component Tree</h3>

<p><img src="https://raw.githubusercontent.com/brechtbilliet/brechtbilliet.github.io/master/_posts/reactivecalendar/reactivecalendar3.png" alt="The component tree" />
The dumb components (blue) are already implemented. The <code class="language-plaintext highlighter-rouge">app-root</code> (orange) is the one and only smart component in the application and the only place where we will write code.</p>

<p>If you don’t know the difference between smart and dumb components, <a href="http://blog.brecht.io/components-demystified/#smart-vs-dumb-components">read this first</a>.</p>

<h3 id="installing-the-project-locally">Installing the Project Locally</h3>
<p>First of all, we have to clone the project locally and check out the <strong>initial</strong> branch. This branch already contains all the uninteresting parts that don’t have anything to do with this article.</p>

<p>In the terminal, we have to go to the folder where we want to install the project and run the following commands:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ git clone git@github.com:brechtbilliet/reactive-calendar.git
$ cd reactive-calendar/reactive-calendar
$ git checkout initial
$ npm install
</code></pre></div></div>

<h3 id="setting-up-firebase">Setting Up Firebase</h3>

<p>We are using <a href="https://firebase.google.com/">Firebase</a> as our backend because it requires minimal setup, it’s realtime by default, and <a href="https://github.com/angular/angularfire2">AngularFire</a> gives us streams for free. We can complete the Firebase configuration in a few steps:</p>

<ul>
  <li>Go to <a href="https://firebase.google.com/">https://firebase.google.com</a>, click on the “GO TO CONSOLE” button, and choose your Google account.</li>
  <li>Click on the “Add project” button and choose a name for your project. Let’s take <strong>“reactive-calendar”</strong> to keep it simple.</li>
  <li>Click on the “CREATE PROJECT” button. Now we should be redirected to <a href="https://console.firebase.google.com/project/reactive-calendar/overview">something like this</a>.</li>
  <li>In the Authentication tab, go to “SIGN-IN METHOD” and enable the “Anonymous” setting.</li>
  <li>Click on database and navigate to the rules tab. Set the read and write property to “true” and click “publish”:
    <div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"rules"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">".read"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="p">,</span><span class="w">
      </span><span class="nl">".write"</span><span class="p">:</span><span class="w"> </span><span class="s2">"true"</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div>    </div>
  </li>
  <li>Go back to the overview by clicking on the home icon, and then select “Add Firebase to your web app”.</li>
  <li>Copy the config with the correct properties and replace the firebaseConfig object in src/app/app.module.ts with these properties.
It might look something like this:</li>
</ul>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">const</span> <span class="nx">firebaseConfig</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">apiKey</span><span class="p">:</span> <span class="dl">"</span><span class="s2">AIzaSyBuqjTJd5v6xTf8D2EZmvFUl8lseH8lVuHU</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">authDomain</span><span class="p">:</span> <span class="dl">"</span><span class="s2">reactive-calendar.firebaseapp.com</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">databaseURL</span><span class="p">:</span> <span class="dl">"</span><span class="s2">https://reactive-calendar.firebaseio.com</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">projectId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">reactive-calendar</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">storageBucket</span><span class="p">:</span> <span class="dl">"</span><span class="s2">reactive-calendar.appspot.com</span><span class="dl">"</span><span class="p">,</span>
    <span class="na">messagingSenderId</span><span class="p">:</span> <span class="dl">"</span><span class="s2">3978123451455750</span><span class="dl">"</span>
<span class="p">};</span>
</code></pre></div></div>

<p>Let’s continue. Start the project by running the following command and open your browser on <a href="http://localhost:4200">http://localhost:4200</a>.</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>npm start
</code></pre></div></div>

<p>As you can see, this just handles static data, the buttons/inputs won’t work, and the appointments are not loaded yet.
This is where we start from.</p>

<h2 id="thinking-reactively">Thinking Reactively</h2>

<p>Now comes the tricky part. We are trying to forget imperative programming for now, and we are trying to evolve into a reactive mindset.</p>

<h3 id="marble-diagrams">Marble Diagrams</h3>

<p>To be able to think reactively, we need some kind of graphic model so we can picture streams in our head. Marble diagrams are a great way to do that.
As you can see in the image below, a marble represents a value over time.</p>

<p><img src="https://raw.githubusercontent.com/brechtbilliet/brechtbilliet.github.io/master/_posts/reactivecalendar/reactivecalendar12.png" alt="Marble diagrams" /></p>

<p>The website <a href="http://rxmarbles.com/">rxmarbles.com</a> has a great playground for learning how to use and draw marble diagrams.</p>

<h4 id="ascii-documentation">ASCII Documentation</h4>

<p>One could argue that code should not be documented and be self-explanatory. I don’t believe that to be the case when writing complex streams. When we document complex streams, we can see what’s going on inside the stream, which makes it easier for our colleagues.
Streams can be documented by ASCII documentation. Since that is not really part of this article, I’m only going to show a small example below.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// a$ gets three values over time and then stops</span>
<span class="c1">// a$: -------a-----b-----c|</span>

<span class="c1">// b$ has an initial value (a), has three values in total</span>
<span class="c1">// and will keep on living</span>
<span class="c1">// b$: a------b-----c------...</span>
</code></pre></div></div>

<h3 id="imperative-programming-what-does-the-app-have-to-do">Imperative Programming: What Does the App Have to Do?</h3>

<p>When we think about the functionality of our application, we quickly notice that there are quite a few corner cases and special scenarios. For every interaction the user makes in the UI, the app needs to handle that specific interaction accordingly. Sometimes it has to combine these interactions and handle that specific combination as well. Take this crazy (but simple) example, for instance.</p>

<blockquote>
When the view mode is changed to week mode, and the previous view mode was month mode, and the month was June, and the year was 2017, and an appointment was added, while the search term was set to "Brecht", then we would have to update...
</blockquote>

<p>Yes, we would have to update a bunch of stuff. This is imperative thinking, and it can become exhausting. There is a big chance that we forget certain corner cases. Let’s not even imagine that we have to combine that with asynchronous actions as well.</p>

<p>In the image below, we see all the different interactions the user has in the calendar application.
<img src="https://raw.githubusercontent.com/brechtbilliet/brechtbilliet.github.io/master/_posts/reactivecalendar/reactivecalendar2.png" alt="Application events" /></p>

<p>As we can see, for every specific interaction, the UI will have to update specific things.</p>

<h3 id="reactivepprogramming-what-data-will-change-and-what-data-do-the-components-need">ReactivePprogramming: What Data Will Change, and What Data Do the Components Need?</h3>

<h4 id="source-streams">Source Streams</h4>

<p>Now, let’s completely stop with what we are thinking. Let’s free our minds and stop thinking about corner cases and special scenarios. We have to learn to think in streams. A stream is a collection of events that will change over time. Think about what can change in your application and call these streams of data. Let’s call them <strong>source streams</strong>.</p>

<p><strong>Note:</strong> For readability purposes, we will suffix all the streams with a <code class="language-plaintext highlighter-rouge">$</code> symbol.</p>

<p>We can come up with 4 source streams:</p>

<ul>
  <li><strong>navigation$:</strong> Can contain the values: -1, 0 or 1</li>
  <li><strong>viewMode$:</strong> Can contain the values: DAY, WEEK, or MONTH</li>
  <li><strong>searchTerm$:</strong> The value of the search field</li>
  <li><strong>appointments$:</strong> This is an array of appointments that comes from Firebase</li>
</ul>

<p><img src="https://raw.githubusercontent.com/brechtbilliet/brechtbilliet.github.io/master/_posts/reactivecalendar/reactivecalendar4.png" alt="data streams" /></p>

<p>That was pretty easy. We just had to think about the events that can occur in our application. A user can navigate, change view mode, search for appointments, and the appointments in Firebase can change. This is the beginning of thinking reactively. Don’t think about who triggers what. Think about the changes as streams.</p>

<p>It’s always a good idea to draw marble diagrams to make it easier to reason.</p>

<p><img src="https://raw.githubusercontent.com/brechtbilliet/brechtbilliet.github.io/master/_posts/reactivecalendar/reactivecalendar5.png" alt="data stream diagram" /></p>

<p><code class="language-plaintext highlighter-rouge">The appointments$</code> is a stream that will be provided to us by AngularFire, but the <code class="language-plaintext highlighter-rouge">viewMode$</code>, <code class="language-plaintext highlighter-rouge">searchTerm$</code>, and <code class="language-plaintext highlighter-rouge">navigation$</code> are simple behavior subjects. We use subjects because we need to control the values of the streams ourselves, and we use the <code class="language-plaintext highlighter-rouge">BehaviorSubject</code> in particular because all our source streams need an initial value.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">class</span> <span class="nx">AppComponent</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="c1">// this is how we can retrieve the list of appointments from angularfire</span>
    <span class="nx">appointments$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">list</span><span class="p">(</span><span class="dl">'</span><span class="s1">/appointments</span><span class="dl">'</span><span class="p">);</span>
     <span class="c1">// 0--------(+1)----(+1)----(-1)-------------...</span>
    <span class="nx">viewMode$</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BehaviorSubject</span><span class="p">(</span><span class="nx">VIEW_MODE</span><span class="p">.</span><span class="nx">MONTH</span><span class="p">);</span>
    <span class="nx">navigation$</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BehaviorSubject</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="nx">searchTerm$</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BehaviorSubject</span><span class="p">(</span><span class="dl">''</span><span class="p">);</span>

	<span class="c1">// because we set up the angularfire configuration correctly, we can just</span>
	<span class="c1">// inject the angularfiredatabase right here and use it</span>
    <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">db</span><span class="p">:</span> <span class="nx">AngularFireDatabase</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>

</code></pre></div></div>

<p>These subjects get values from the simple interactions from the template.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
    <span class="p">...</span>
    <span class="na">template</span><span class="p">:</span> <span class="s2">`
        &lt;topbar
                (next)="onNext()"
                (previous)="onPrevious()"
                (setViewMode)="onSetViewMode($event)"
                (searchChanged)="onSearchChanged($event)"&gt;
        &lt;/topbar&gt;
        ...
    `</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppComponent</span> <span class="p">{</span>
    <span class="p">...</span>
    
    <span class="nx">onSetViewMode</span><span class="p">(</span><span class="nx">viewMode</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
        <span class="c1">// when the viewmode changes, update its subject</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">viewMode$</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">viewMode</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">onPrevious</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
        <span class="c1">// when the user clicks the previous button</span>
        <span class="c1">// update the navigation subject</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">navigation$</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">onNext</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
        <span class="c1">// when the user clicks the next button</span>
        <span class="c1">// update the navigation subject</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">navigation$</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">onSearchChanged</span><span class="p">(</span><span class="nx">e</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
        <span class="c1">// when the user searches</span>
        <span class="c1">// update the searchterm subject</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">searchTerm$</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<h4 id="presentational-streams">Presentational Streams</h4>

<p>Now we have to think about the data that our components need, because those components will need to be updated based on those source streams.
Let’s take this code sample, for instance:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">[ngSwitch]=</span><span class="s">"XX"</span> <span class="na">class=</span><span class="s">"main"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;day-view</span>
            <span class="na">*ngSwitchCase=</span><span class="s">"'DAY'"</span>
            <span class="na">[appointments]=</span><span class="s">"XX"</span>
            <span class="na">[date]=</span><span class="s">"XX"</span>
            <span class="err">...</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/day-view&gt;</span>
    <span class="nt">&lt;week-view</span>
            <span class="na">*ngSwitchCase=</span><span class="s">"'WEEK'"</span>
            <span class="na">[appointments]=</span><span class="s">"XX"</span>
            <span class="na">[year]=</span><span class="s">"XX"</span>
            <span class="na">[week]=</span><span class="s">"XX"</span>
            <span class="err">...</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/week-view&gt;</span>
    <span class="nt">&lt;month-view</span>
            <span class="na">*ngSwitchCase=</span><span class="s">"'MONTH'"</span>
            <span class="na">[month]=</span><span class="s">"XX"</span>
            <span class="na">[year]=</span><span class="s">"XX"</span>
            <span class="na">[appointments]=</span><span class="s">"xxx"</span>
            <span class="err">...</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/month-view&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>I marked the input properties with XX to show what our components need in terms of data. These places will need streams as well. Let’s call them <strong>presentational streams</strong>.</p>

<p>Let’s try to fill in these gaps, shall we?</p>

<p><strong>Note:</strong> We use the <a href="https://angular.io/api/common/AsyncPipe">async pipe</a> from Angular to subscribe/unsubscribe the streams automatically.</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;div</span> <span class="na">[ngSwitch]=</span><span class="s">"viewMode$|async"</span> <span class="na">class=</span><span class="s">"main"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;day-view</span>
            <span class="na">*ngSwitchCase=</span><span class="s">"'DAY'"</span>
            <span class="na">[appointments]=</span><span class="s">"filteredAppointments$|async"</span>
            <span class="na">[date]=</span><span class="s">"currentDate$|async"</span>
            <span class="err">...</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/day-view&gt;</span>
    <span class="nt">&lt;week-view</span>
            <span class="na">*ngSwitchCase=</span><span class="s">"'WEEK'"</span>
            <span class="na">[appointments]=</span><span class="s">"filteredAppointments$|async"</span>
            <span class="na">[year]=</span><span class="s">"currentYear$|async"</span>
            <span class="na">[week]=</span><span class="s">"currentWeek$|async"</span>
            <span class="err">...</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/week-view&gt;</span>
    <span class="nt">&lt;month-view</span>
            <span class="na">*ngSwitchCase=</span><span class="s">"'MONTH'"</span>
            <span class="na">[month]=</span><span class="s">"currentMonth$|async"</span>
            <span class="na">[year]=</span><span class="s">"currentYear$|async"</span>
            <span class="na">[appointments]=</span><span class="s">"filteredAppointments$|async"</span>
            <span class="err">...</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/month-view&gt;</span>
<span class="nt">&lt;/div&gt;</span>
</code></pre></div></div>

<p>We have gathered the 6 following presentational streams:</p>

<ul>
  <li><strong>viewMode$ (string):</strong> needed to determine which view has to be shown</li>
  <li><strong>filteredAppointments$ (Array &lt; Appointment &gt;):</strong> needed by day view, week view, and month view to render the correct appointments</li>
  <li><strong>currentDate$ (date):</strong> the current date for the day view</li>
  <li><strong>currentWeek$ (number):</strong> the current week for the week view</li>
  <li><strong>currentYear$ (number):</strong> needed by week view and month view</li>
  <li><strong>currentMonth$ (number):</strong> needed by the month view</li>
</ul>

<p>Okay, great, we know the source streams, which are the sources of change in our application.
We know the presentational streams, which are simply the streams that our components need. Now it’s time for the cool part: <strong>We need to create those presentational streams based on the source streams</strong>.</p>

<p><img src="https://raw.githubusercontent.com/brechtbilliet/brechtbilliet.github.io/master/_posts/reactivecalendar/reactivecalendar6.png" alt="sources to presentational streams" /></p>

<p>The first presentational stream we need is <code class="language-plaintext highlighter-rouge">viewMode$</code>. This is already an easy one, since <code class="language-plaintext highlighter-rouge">viewMode$</code> is also a source stream.</p>

<h4 id="currentdate">currentDate$</h4>
<p><img src="https://raw.githubusercontent.com/brechtbilliet/brechtbilliet.github.io/master/_posts/reactivecalendar/reactivecalendar7.png" alt="currentDate$" /></p>

<p><strong>Note:</strong> We use moment.js for date calculation. The suffix M after the currentDate property shows that the type is <code class="language-plaintext highlighter-rouge">Moment</code>. So in short, it’s not just a date, but a moment wrapper.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// we will need this stream a few times, so let's extract the stream </span>
<span class="c1">// in a currentDateM first</span>

<span class="c1">// viewMode$:     M------------------W---------------D--------...</span>
<span class="c1">// navigation$:   0---(+1)-(-1)----------(+1)-(-1)------------...</span>
<span class="c1">// currentDateM$: d---d----d---------d---d----d------d--------...</span>
<span class="k">private</span> <span class="nx">currentDateM</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">viewMode$</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">((</span><span class="nx">viewMode</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="c1">// every time the viewMode changes, the navigation should be reset as well</span>
    <span class="c1">// the dateM variable will contain the navigation and because of the </span>
    <span class="c1">// flatMap it will reset every time the view mode changes</span>
    <span class="c1">// if the navigation$ changes afterwards it will manipulate the dateM object</span>
    <span class="c1">// by adding months, weeks, or days depending on the viewMode</span>
    <span class="kd">const</span> <span class="nx">dateM</span> <span class="o">=</span> <span class="nx">moment</span><span class="p">();</span>
    <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">navigation$</span>
        <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="na">action</span><span class="p">:</span> <span class="kr">number</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="nx">viewMode</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="nx">VIEW_MODE</span><span class="p">.</span><span class="na">MONTH</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nx">dateM</span><span class="p">.</span><span class="nx">startOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">month</span><span class="dl">'</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">action</span><span class="p">,</span> <span class="dl">"</span><span class="s2">months</span><span class="dl">"</span><span class="p">);</span>
                <span class="k">case</span> <span class="nx">VIEW_MODE</span><span class="p">.</span><span class="na">WEEK</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nx">dateM</span><span class="p">.</span><span class="nx">startOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">week</span><span class="dl">'</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">action</span><span class="p">,</span> <span class="dl">"</span><span class="s2">weeks</span><span class="dl">"</span><span class="p">);</span>
                <span class="k">case</span> <span class="nx">VIEW_MODE</span><span class="p">.</span><span class="na">DAY</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nx">dateM</span><span class="p">.</span><span class="nx">startOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">day</span><span class="dl">'</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">action</span><span class="p">,</span> <span class="dl">"</span><span class="s2">days</span><span class="dl">"</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nx">dateM</span><span class="p">;</span>
        <span class="p">})</span>
<span class="p">})</span>
<span class="nx">currentDate$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentDateM$</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">dateM</span> <span class="o">=&gt;</span> <span class="nx">dateM</span><span class="p">.</span><span class="nx">toDate</span><span class="p">());</span>

</code></pre></div></div>

<h4 id="currentweek">currentWeek$</h4>

<p>Based on the <code class="language-plaintext highlighter-rouge">currentDateM$</code> we can calculate the current week. The <code class="language-plaintext highlighter-rouge">currentDateM$</code> is just a moment object of the current date based on the navigation and viewMode.</p>

<p><img src="https://raw.githubusercontent.com/brechtbilliet/brechtbilliet.github.io/master/_posts/reactivecalendar/reactivecalendar8.png" alt="currentWeek$" /></p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">currentWeek$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentDateM$</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">dateM</span> <span class="o">=&gt;</span> <span class="nx">dateM</span><span class="p">.</span><span class="nx">week</span><span class="p">());</span>
</code></pre></div></div>

<h4 id="currentmonth">currentMonth$</h4>

<p>Just like we calculated the <code class="language-plaintext highlighter-rouge">currentWeek$</code> based on the <code class="language-plaintext highlighter-rouge">currentDateM$</code>, we can do the same thing here.</p>

<p><img src="https://raw.githubusercontent.com/brechtbilliet/brechtbilliet.github.io/master/_posts/reactivecalendar/reactivecalendar9.png" alt="currentMonth$" /></p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">currentMonth$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentDateM$</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">dateM</span> <span class="o">=&gt;</span> <span class="nx">dateM</span><span class="p">.</span><span class="nx">month</span><span class="p">());</span>
</code></pre></div></div>
<h4 id="currentyear">currentYear$</h4>

<p>Just like we calculated the <code class="language-plaintext highlighter-rouge">currentWeek$</code> and the <code class="language-plaintext highlighter-rouge">currentMonth$</code> based on the <code class="language-plaintext highlighter-rouge">currentDateM$</code>, we can do the same thing here.</p>

<p><img src="https://raw.githubusercontent.com/brechtbilliet/brechtbilliet.github.io/master/_posts/reactivecalendar/reactivecalendar10.png" alt="currentYear$" /></p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">currentYear$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentDateM$</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">dateM</span> <span class="o">=&gt;</span> <span class="nx">dateM</span><span class="p">.</span><span class="nx">year</span><span class="p">());</span>
</code></pre></div></div>

<h4 id="filteredappointments">filteredAppointments$</h4>

<p>This is the most important stream. It is used to show the appointments in all the different views, and it is dependent on a bunch of streams:</p>

<ul>
  <li>viewMode$</li>
  <li>currentDateM$</li>
  <li>appointments$</li>
  <li>searchTerm$</li>
</ul>

<p>This looks a bit more complex, but let’s give it a go.</p>

<p><strong>Note:</strong> the <code class="language-plaintext highlighter-rouge">[]</code> in the image below stands for an empty array, the <code class="language-plaintext highlighter-rouge">[.]</code> for an array with one value, and so on.</p>

<p><img src="https://raw.githubusercontent.com/brechtbilliet/brechtbilliet.github.io/master/_posts/reactivecalendar/reactivecalendar11.png" alt="filteredAppointment$" /></p>

<p>Let’s take the time to process this image. The operator we will use to combine all these streams is called <strong>combineLatest</strong>. It will create a stream that will wait until all streams have a value and will start emitting values for every change of every stream.</p>

<p>So basically, it gives us a function where we have all the information we need. The appointments in Firebase, the view mode, the search term, and the current date. Based on those values, we can calculate the appointments for every view:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">filteredAppointments$</span> <span class="o">=</span> <span class="nx">Observable</span><span class="p">.</span><span class="nx">combineLatest</span><span class="p">(</span>
    <span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">viewMode$</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentDateM$</span><span class="p">,</span> 
    <span class="k">this</span><span class="p">.</span><span class="nx">appointments$</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">searchTerm$</span><span class="p">],</span>
    <span class="p">(</span><span class="nx">viewMode</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">currentDateM</span><span class="p">:</span> <span class="nx">Moment</span><span class="p">,</span> 
        <span class="nx">appointments</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">Appointment</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">searchTerm</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">switch</span> <span class="p">(</span><span class="nx">viewMode</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// calculate the appointments for the month-view based on</span>
            <span class="c1">// the current date, the appointments in firebase </span>
            <span class="c1">// and the searchterm</span>
            <span class="k">case</span> <span class="nx">VIEW_MODE</span><span class="p">.</span><span class="na">MONTH</span><span class="p">:</span>
                <span class="k">return</span> <span class="nx">appointments</span>
                    <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">date</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="dl">'</span><span class="s1">MM/YYYY</span><span class="dl">'</span><span class="p">)</span> <span class="o">===</span> <span class="nx">currentDateM</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="dl">'</span><span class="s1">MM/YYYY</span><span class="dl">'</span><span class="p">))</span>
                    <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">filterByTerm</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">searchTerm</span><span class="p">));</span>
             <span class="c1">// calculate the appointments for the week-view based on</span>
             <span class="c1">// the current date, the appointments in firebase</span>
             <span class="c1">// and the searchterm</span>
            <span class="k">case</span> <span class="nx">VIEW_MODE</span><span class="p">.</span><span class="na">WEEK</span><span class="p">:</span>
                <span class="k">return</span> <span class="nx">appointments</span>
                    <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">date</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="dl">'</span><span class="s1">ww/YYYY</span><span class="dl">'</span><span class="p">)</span> <span class="o">===</span> <span class="nx">currentDateM</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="dl">'</span><span class="s1">ww/YYYY</span><span class="dl">'</span><span class="p">))</span>
                    <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">filterByTerm</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">searchTerm</span><span class="p">));</span>
            <span class="c1">// calculate the appointments for the day-view based on</span>
            <span class="c1">// the current date, the appointments in firebase</span>
            <span class="c1">// and the searchterm</span>
            <span class="k">case</span> <span class="nx">VIEW_MODE</span><span class="p">.</span><span class="na">DAY</span><span class="p">:</span>
                <span class="k">return</span> <span class="nx">appointments</span>
                    <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">date</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="dl">'</span><span class="s1">DD/MM/YYYY</span><span class="dl">'</span><span class="p">)</span> <span class="o">===</span> <span class="nx">currentDateM</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="dl">'</span><span class="s1">DD/MM/YYYY</span><span class="dl">'</span><span class="p">))</span>
                    <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">filterByTerm</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">searchTerm</span><span class="p">));</span>

        <span class="p">}</span>
    <span class="p">});</span>

<span class="k">private</span> <span class="nx">filterByTerm</span><span class="p">(</span><span class="nx">appointment</span><span class="p">:</span> <span class="nx">Appointment</span><span class="p">,</span> <span class="nx">term</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nx">boolean</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">appointment</span><span class="p">.</span><span class="nx">description</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">term</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">())</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is all we have to do in order to create a kick-ass realtime reactive calendar application. We have created it in no time and with only a few lines of code. If we think about it, we will soon realize that all corner cases have been covered.</p>

<h2 id="performance-improvements">Performance Improvements</h2>

<p>The complete component looks like the code snippet below now. The calendar should be completely functional in your browser.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Component</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@angular/core</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">VIEW_MODE</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../constants</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="o">*</span> <span class="k">as</span> <span class="nx">moment</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">moment</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Appointment</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">../../types/appointment.type</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">AngularFireDatabase</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">angularfire2/database</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">Observable</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">rxjs/Observable</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="nx">Moment</span> <span class="o">=</span> <span class="nx">moment</span><span class="p">.</span><span class="nx">Moment</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">BehaviorSubject</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">rxjs/BehaviorSubject</span><span class="dl">'</span><span class="p">;</span>


<span class="p">@</span><span class="nd">Component</span><span class="p">({</span>
    <span class="na">selector</span><span class="p">:</span> <span class="dl">'</span><span class="s1">app-root</span><span class="dl">'</span><span class="p">,</span>
    <span class="na">template</span><span class="p">:</span> <span class="s2">`
        &lt;topbar
                (next)="onNext()"
                (previous)="onPrevious()"
                (setViewMode)="onSetViewMode($event)"
                (searchChanged)="onSearchChanged($event)"&gt;
        &lt;/topbar&gt;
        &lt;div [ngSwitch]="viewMode$|async"&gt;
            &lt;day-view
                    *ngSwitchCase="VIEW_MODE.DAY"
                    [appointments]="filteredAppointments$|async"
                    [date]="currentDate$|async"
                    (removeAppointment)="onRemoveAppointment($event)"
                    (addAppointment)="onAddAppointment($event)"
                    (updateAppointment)="onUpdateAppointment($event)"
            &gt;
            &lt;/day-view&gt;
            &lt;week-view
                    *ngSwitchCase="VIEW_MODE.WEEK"
                    [appointments]="filteredAppointments$|async"
                    [year]="currentYear$|async"
                    [week]="currentWeek$|async"
                    (removeAppointment)="onRemoveAppointment($event)"
                    (addAppointment)="onAddAppointment($event)"
                    (updateAppointment)="onUpdateAppointment($event)"
            &gt;
            &lt;/week-view&gt;
            &lt;month-view
                    *ngSwitchCase="VIEW_MODE.MONTH"
                    [month]="currentMonth$|async"
                    [year]="currentYear$|async"
                    [appointments]="filteredAppointments$|async"
                    (removeAppointment)="onRemoveAppointment($event)"
                    (addAppointment)="onAddAppointment($event)"
                    (updateAppointment)="onUpdateAppointment($event)"
            &gt;
            &lt;/month-view&gt;
        &lt;/div&gt;
    `</span><span class="p">,</span>
    <span class="na">styleUrls</span><span class="p">:</span> <span class="p">[</span><span class="dl">'</span><span class="s1">./app.component.less</span><span class="dl">'</span><span class="p">]</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppComponent</span> <span class="p">{</span>
    <span class="nx">VIEW_MODE</span> <span class="o">=</span> <span class="nx">VIEW_MODE</span><span class="p">;</span>
    <span class="nx">viewMode$</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BehaviorSubject</span><span class="p">(</span><span class="nx">VIEW_MODE</span><span class="p">.</span><span class="nx">MONTH</span><span class="p">);</span>
    <span class="c1">// 0--------(+1)----(+1)----(-1)-------------...</span>
    <span class="nx">navigation$</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BehaviorSubject</span><span class="o">&lt;</span><span class="kr">number</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="nx">searchTerm$</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BehaviorSubject</span><span class="p">(</span><span class="dl">''</span><span class="p">);</span>

    <span class="c1">// -----MONTH---------------------YEAR------...</span>
    <span class="c1">// -----MONTH-------------------------------...</span>
    <span class="c1">// -----(d)---------------------------------...</span>
    <span class="c1">// --------(+1)----(+1)----(-1)-------------...</span>
    <span class="c1">// -----d---d-------d-------d-----d----------...</span>

    <span class="k">private</span> <span class="nx">currentDateM$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">viewMode$</span><span class="p">.</span><span class="nx">flatMap</span><span class="p">((</span><span class="nx">viewMode</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">dateM</span> <span class="o">=</span> <span class="nx">moment</span><span class="p">();</span>
        <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">navigation$</span>
            <span class="p">.</span><span class="nx">map</span><span class="p">((</span><span class="na">action</span><span class="p">:</span> <span class="kr">number</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="k">switch</span> <span class="p">(</span><span class="nx">viewMode</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">case</span> <span class="nx">VIEW_MODE</span><span class="p">.</span><span class="na">MONTH</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nx">dateM</span><span class="p">.</span><span class="nx">startOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">month</span><span class="dl">'</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">action</span><span class="p">,</span> <span class="dl">'</span><span class="s1">months</span><span class="dl">'</span><span class="p">);</span>
                    <span class="k">case</span> <span class="nx">VIEW_MODE</span><span class="p">.</span><span class="na">WEEK</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nx">dateM</span><span class="p">.</span><span class="nx">startOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">week</span><span class="dl">'</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">action</span><span class="p">,</span> <span class="dl">'</span><span class="s1">weeks</span><span class="dl">'</span><span class="p">);</span>
                    <span class="k">case</span> <span class="nx">VIEW_MODE</span><span class="p">.</span><span class="na">DAY</span><span class="p">:</span>
                        <span class="k">return</span> <span class="nx">dateM</span><span class="p">.</span><span class="nx">startOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">day</span><span class="dl">'</span><span class="p">).</span><span class="nx">add</span><span class="p">(</span><span class="nx">action</span><span class="p">,</span> <span class="dl">'</span><span class="s1">days</span><span class="dl">'</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="k">return</span> <span class="nx">dateM</span><span class="p">;</span>
            <span class="p">})</span>
    <span class="p">});</span>

    <span class="nx">currentDate$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentDateM$</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">dateM</span> <span class="o">=&gt;</span> <span class="nx">dateM</span><span class="p">.</span><span class="nx">toDate</span><span class="p">());</span>
    <span class="nx">currentYear$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentDateM$</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">dateM</span> <span class="o">=&gt;</span> <span class="nx">dateM</span><span class="p">.</span><span class="nx">year</span><span class="p">());</span>
    <span class="nx">currentMonth$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentDateM$</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">dateM</span> <span class="o">=&gt;</span> <span class="nx">dateM</span><span class="p">.</span><span class="nx">month</span><span class="p">());</span>
    <span class="nx">currentWeek$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentDateM$</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">dateM</span> <span class="o">=&gt;</span> <span class="nx">dateM</span><span class="p">.</span><span class="nx">week</span><span class="p">());</span>
    <span class="nx">appointments$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">list</span><span class="p">(</span><span class="dl">'</span><span class="s1">/appointments</span><span class="dl">'</span><span class="p">);</span>
    <span class="nx">filteredAppointments$</span> <span class="o">=</span> <span class="nx">Observable</span><span class="p">.</span><span class="nx">combineLatest</span><span class="p">([</span><span class="k">this</span><span class="p">.</span><span class="nx">viewMode$</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">currentDateM$</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">appointments$</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">searchTerm$</span><span class="p">],</span>
        <span class="p">(</span><span class="nx">viewMode</span><span class="p">:</span> <span class="kr">string</span><span class="p">,</span> <span class="nx">currentDateM</span><span class="p">:</span> <span class="nx">Moment</span><span class="p">,</span> <span class="nx">appointments</span><span class="p">:</span> <span class="nb">Array</span><span class="o">&lt;</span><span class="nx">Appointment</span><span class="o">&gt;</span><span class="p">,</span> <span class="nx">searchTerm</span><span class="p">:</span> <span class="kr">string</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="k">switch</span> <span class="p">(</span><span class="nx">viewMode</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">case</span> <span class="nx">VIEW_MODE</span><span class="p">.</span><span class="na">MONTH</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nx">appointments</span>
                        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">date</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="dl">'</span><span class="s1">MM/YYYY</span><span class="dl">'</span><span class="p">)</span> <span class="o">===</span> <span class="nx">currentDateM</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="dl">'</span><span class="s1">MM/YYYY</span><span class="dl">'</span><span class="p">))</span>
                        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">filterByTerm</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">searchTerm</span><span class="p">));</span>
                <span class="k">case</span> <span class="nx">VIEW_MODE</span><span class="p">.</span><span class="na">WEEK</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nx">appointments</span>
                        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">date</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="dl">'</span><span class="s1">ww/YYYY</span><span class="dl">'</span><span class="p">)</span> <span class="o">===</span> <span class="nx">currentDateM</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="dl">'</span><span class="s1">ww/YYYY</span><span class="dl">'</span><span class="p">))</span>
                        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">filterByTerm</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">searchTerm</span><span class="p">));</span>
                <span class="k">case</span> <span class="nx">VIEW_MODE</span><span class="p">.</span><span class="na">DAY</span><span class="p">:</span>
                    <span class="k">return</span> <span class="nx">appointments</span>
                        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="nx">moment</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">date</span><span class="p">).</span><span class="nx">format</span><span class="p">(</span><span class="dl">'</span><span class="s1">DD/MM/YYYY</span><span class="dl">'</span><span class="p">)</span> <span class="o">===</span> <span class="nx">currentDateM</span><span class="p">.</span><span class="nx">format</span><span class="p">(</span><span class="dl">'</span><span class="s1">DD/MM/YYYY</span><span class="dl">'</span><span class="p">))</span>
                        <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="k">this</span><span class="p">.</span><span class="nx">filterByTerm</span><span class="p">(</span><span class="nx">item</span><span class="p">,</span> <span class="nx">searchTerm</span><span class="p">));</span>

            <span class="p">}</span>
        <span class="p">});</span>

    <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">db</span><span class="p">:</span> <span class="nx">AngularFireDatabase</span><span class="p">)</span> <span class="p">{</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="nx">filterByTerm</span><span class="p">(</span><span class="nx">appointment</span><span class="p">:</span> <span class="nx">Appointment</span><span class="p">,</span> <span class="nx">term</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="nx">boolean</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">appointment</span><span class="p">.</span><span class="nx">description</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">term</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">())</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="nx">onSetViewMode</span><span class="p">(</span><span class="nx">viewMode</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">viewMode$</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">viewMode</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">onPrevious</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">navigation$</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">onNext</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">navigation$</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">onSearchChanged</span><span class="p">(</span><span class="nx">e</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">searchTerm$</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">onRemoveAppointment</span><span class="p">(</span><span class="nx">id</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">appointments$</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">id</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nx">onAddAppointment</span><span class="p">(</span><span class="nx">date</span><span class="p">:</span> <span class="nb">Date</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">appointments$</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">new</span> <span class="nx">Appointment</span><span class="p">(</span><span class="nx">date</span><span class="p">.</span><span class="nx">toDateString</span><span class="p">(),</span> <span class="dl">''</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="nx">onUpdateAppointment</span><span class="p">(</span><span class="nx">appointment</span><span class="p">:</span> <span class="nx">Appointment</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">db</span><span class="p">.</span><span class="nx">object</span><span class="p">(</span><span class="dl">'</span><span class="s1">appointments/</span><span class="dl">'</span> <span class="o">+</span> <span class="nx">appointment</span><span class="p">.</span><span class="nx">$key</span><span class="p">).</span><span class="kd">set</span><span class="p">({</span>
            <span class="na">description</span><span class="p">:</span> <span class="nx">appointment</span><span class="p">.</span><span class="nx">description</span><span class="p">,</span>
            <span class="na">date</span><span class="p">:</span> <span class="nx">appointment</span><span class="p">.</span><span class="nx">date</span>
        <span class="p">});</span>
    <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>There is only one problem. We use the same observables multiple times in our template. Since observables are cold by default, they will get executed every time there is a subscription. In Angular, this means a subscription for every async pipe. For performance reasons, we only want to recalculate these streams when something actually changes. For that purpose, we can try to use the <code class="language-plaintext highlighter-rouge">share()</code> operator from RxJS. The <code class="language-plaintext highlighter-rouge">share()</code> operator is an alias for <code class="language-plaintext highlighter-rouge">publish().refCount()</code> and will share the subscription.</p>

<p>However, that creates some problems with Angular and its async pipe.
The situation of the problem goes like this:</p>

<ul>
  <li>Since we are using BehaviorSubjects, the streams will get an initial value (which is what we want, of course).</li>
  <li>The share() operator will emit that value on the first subscription</li>
  <li>When the app is initialized, the async pipes will start subscribing to the stream.</li>
  <li>Because the first async pipe triggered the first emit the rest of the async pipes will miss that value.</li>
</ul>

<p><strong>Solution: shareReplay() will emit those values but keep track of them. That way, the async pipes will never miss a value.</strong></p>

<h2 id="conclusion">Conclusion</h2>

<p>We have created a completely reactive calendar that is performant and fixes a bunch of corner cases in only a few lines of code. Just by thinking about source streams and presentational streams, it wasn’t even that hard. I hope that I can encourage more people to take on this reactive approach and start writing kick-ass applications.</p>

<h2 id="special-thanks">Special Thanks</h2>

<p>I would like to give special thanks to the awesome people that reviewed this post and gave me pointers:</p>

<ul>
  <li>Dominic Elm (<a href="https://twitter.com/elmd_">@elmd_</a>)</li>
  <li>Manfred Steyer (<a href="https://twitter.com/manfredsteyer">@manfredsteyer</a>)</li>
  <li>David Müllerchen (<a href="https://twitter.com/webdave_de">@webdave_de</a>)</li>
  <li>Maxim Robert (<a href="https://twitter.com/sizerone">@sizerOne</a>)</li>
</ul>

<p>Thanks, guys! It means a lot!</p>

  </div><a class="u-url" href="/Creating-reactive-calendar-in-angular4/" hidden></a>
</article>

                </div>
            </main>
        </div><div class="footer">
    <div class="footer__inner"><h3>Let's get to know each other!</h3>
        <ul class="footer__social-icons">
            <li><a href="https://www.linkedin.com/in/brecht-billiet-58417426/" target="blank"
                   class="footer__social-icon"><i class="fa-brands fa-linkedin"></i></a></li>
            <li><a href="https://twitter.com/brechtbilliet" target="blank" class="footer__social-icon"><i
                    class="fa-brands fa-twitter"></i></a></li>
            <li><a href="mailto://billietbrecht@gmail.com" target="blank" class="footer__social-icon"><i
                    class="fa-solid fa-envelope-open"></i></a></li>
        </ul>
        <a href="#" id="open_preferences_center">Change your preferences</a>
    </div>
</div>
</div>
</section>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-43296458-4"></script>
<script type="text/javascript" src="//www.privacypolicies.com/public/cookie-consent/4.0.0/cookie-consent.js" charset="UTF-8"></script>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        cookieconsent.run({"notice_banner_type":"simple","consent_type":"implied","palette":"light","language":"en","page_load_consent_levels":["strictly-necessary","functionality","tracking","targeting"],"notice_banner_reject_button_hide":false,"preferences_center_close_button_hide":false,"page_refresh_confirmation_buttons":false,"website_name":"brecht.io"});
    });
</script>
<script cookie-consent="tracking">
    window.dataLayer = window.dataLayer || [];
    function gtag(){
        dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'UA-43296458-4');
</script>
<noscript>Cookie Consent by <a href="https://www.privacypolicies.com/" rel="noopener">Privacy Policies Generator website</a></noscript>
</body>

</html>
