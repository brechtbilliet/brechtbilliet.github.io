<!DOCTYPE html>
<html lang=" en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="robots" content="User-agent: *" />
  <link rel="icon" type="image/x-icon" href="/assets/favicon.ico">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css"/><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>A generic way of handling loading-status, saving-status and validation errors in Angular | Frontend software architect living in Belgium</title>
<meta name="generator" content="Jekyll v4.2.2" />
<meta property="og:title" content="A generic way of handling loading-status, saving-status and validation errors in Angular" />
<meta name="author" content="brechtbilliet" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="In this article we are going to implement a generic solution on how to fix 3 common usecases that involve redundancy in CRUD applications." />
<meta property="og:description" content="In this article we are going to implement a generic solution on how to fix 3 common usecases that involve redundancy in CRUD applications." />
<link rel="canonical" href="http://localhost:4000/generic-way-of-handling-loading-saving-and-validationerrors-in-angular/" />
<meta property="og:url" content="http://localhost:4000/generic-way-of-handling-loading-saving-and-validationerrors-in-angular/" />
<meta property="og:site_name" content="Frontend software architect living in Belgium" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-01-25T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="A generic way of handling loading-status, saving-status and validation errors in Angular" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"brechtbilliet"},"dateModified":"2019-01-25T00:00:00+01:00","datePublished":"2019-01-25T00:00:00+01:00","description":"In this article we are going to implement a generic solution on how to fix 3 common usecases that involve redundancy in CRUD applications.","headline":"A generic way of handling loading-status, saving-status and validation errors in Angular","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/generic-way-of-handling-loading-saving-and-validationerrors-in-angular/"},"url":"http://localhost:4000/generic-way-of-handling-loading-saving-and-validationerrors-in-angular/"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Frontend software architect living in Belgium" /></head>
<body>
<section class="app">
    <div class="app__nav-wrapper">
        <nav class="app__menu">
            <button class="app__menu-close-btn">
                <span>CLOSE</span>&nbsp;
                <i class="fa-solid fa-circle-xmark"></i>
            </button>
            <ul>
                <li>
                    <a href="https://brecht.io">
                        <span class="app__menu-item-label">Home</span>
                    </a>
                </li>
                <li>
                    <a href="https://brecht.io/about">
                        <span class="app__menu-item-label">About</span>
                    </a>
                </li>
                <li>
                    <a href="https://brecht.io/services">
                        <span class="app__menu-item-label">Services</span>
                    </a>
                </li>
                <li>
                    <a href="https://brecht.io/angular-best-practices-training">
                        <span class="app__menu-item-label">Angular Best Practices Training</span>
                    </a>
                </li>
                <li>
                    <a href="https://blog.brecht.io" class="link--active">
                        <span class="app__menu-item-label">Blog</span>
                    </a>
                </li>
                <li>
                    <a href="https://brecht.io/contact">
                        <span class="app__menu-item-label">Contact</span>
                    </a>
                </li>
            </ul>
        </nav>
    </div>
    <button class="app__menu-mobile-btn" id="menu-button">
        <i class="fa-solid fa-bars"></i>
        &nbsp;MENU
    </button>

    <div id="container__wrapper">
        <div>
            <header class="blog__header">
                <div class="page__wrapper">
                </div>
            </header>
            <main aria-label="Content">
                <div class="blog">
                    <div class="page__wrapper page__wrapper-flex">
                        <div class="page__wrapper-left">
                            <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">A generic way of handling loading-status, saving-status and validation errors in Angular</h1>
    <p class="post-meta">
      <img class="author-thumb" src="/assets/images/brecht.png" alt="Author image" nopin="nopin" />
      <time class="dt-published" datetime="2019-01-25T00:00:00+01:00" itemprop="datePublished">Jan 25, 2019
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Brecht Billiet</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <p>When writing Angular applications there are always pieces of functionality that are being rewritten over and over again. 3 common usecases are:</p>

<ul>
  <li>Showing a <em>loading</em> status</li>
  <li>Showing an <em>acting</em> status (whether the user is adding, updating or removing data)</li>
  <li>Showing validation errors</li>
</ul>

<p>In this article we are going to implement a generic solution on how to fix these usecases.</p>

<h2 id="a-non-generic-way-of-loading-saving-and-handling-validation-errors-in-angular">A non generic way of loading, saving and handling validation errors in Angular</h2>

<p>Before we jump to the solution, let’s have a look at the impact of a non generic way of handling the previous called functionalities.
A solution that is often used might look like the following: (keep in mind that this functionality has to be implemented over and over again for every component)</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">ngOnInit</span><span class="p">():</span> <span class="k">void</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">loading</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">usersCompleted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="kd">const</span> <span class="nx">citiesCompleted</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">userService</span><span class="p">.</span><span class="nx">fetch</span><span class="p">().</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">users</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">usersCompleted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">loading</span> <span class="o">=</span> <span class="nx">usersCompleted</span> <span class="o">&amp;&amp;</span> <span class="nx">citiesCompleted</span><span class="p">;</span>
    <span class="p">});</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">citiesService</span><span class="p">.</span><span class="nx">fetch</span><span class="p">().</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">cities</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">citiesCompleted</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">loading</span> <span class="o">=</span> <span class="nx">usersCompleted</span> <span class="o">&amp;&amp;</span> <span class="nx">citiesCompleted</span><span class="p">;</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>
<p>We have to keep track of which call completes first because we can’t set loading to false, if there is call still busy. What happens when there is an error? We would have to implement that as well.</p>

<p>Now this code is only for fetching two lists of data, this becomes ugly pretty quickly and the worst thing about this is that we have to reimplement that for every component that does data fetching.</p>

<p>It becomes even worse if we want to update, add and remove data. Imagine that we have to handle validation errors as well:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">remove</span><span class="p">(</span><span class="nx">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="c1">// TODO: set acting to true</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">userService</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// TODO: set acting to false</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="nx">update</span><span class="p">(</span><span class="nx">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="c1">// TODO: set acting to true</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">userService</span><span class="p">.</span><span class="nx">update</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// TODO: set acting to false</span>
        <span class="c1">// TODO: handle validation errors</span>
    <span class="p">});</span>
<span class="p">}</span>
<span class="nx">add</span><span class="p">(</span><span class="nx">user</span><span class="p">:</span> <span class="nx">User</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="c1">// TODO: set acting to true</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">userService</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">user</span><span class="p">).</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">res</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="c1">// TODO: set acting to false</span>
        <span class="c1">// TODO: handle validation errors</span>
    <span class="p">});</span>
<span class="p">}</span>
</code></pre></div></div>

<p>To handle validation errors we have to check if the HTTP status code is 400, manually map the data etc.</p>

<p>These code samples are in this article to prove a point. <strong>It’s dirty redundant logic that we have to implement over and over again</strong></p>

<h2 id="lets-clean-this-up">Let’s clean this up</h2>

<p>To achieve this we will use an Angular <em>service</em> in combination with an angular <em>interceptor</em> and Typescript <em>decorators</em>.</p>

<p>The first thing we need is a <code class="language-plaintext highlighter-rouge">HttpStatusService</code> that exposes 3 observables:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">loading$</code>: whether the user is fetching data</li>
  <li><code class="language-plaintext highlighter-rouge">acting$</code>: whether the user is removing, updating or adding data</li>
  <li><code class="language-plaintext highlighter-rouge">validationErrors$</code>: whether there are validation errors or not</li>
</ul>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// http-status.service.ts</span>
<span class="p">@</span><span class="nd">Injectable</span><span class="p">({</span>
  <span class="c1">// important to provide this service to the </span>
  <span class="c1">// injector of the root module </span>
  <span class="na">providedIn</span><span class="p">:</span> <span class="dl">'</span><span class="s1">root</span><span class="dl">'</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">HttpStatusService</span> <span class="p">{</span>
  <span class="c1">// regular subject because we don't want to replay</span>
  <span class="c1">// the validationerrors</span>
  <span class="k">private</span> <span class="nx">validationErrorsSub$</span> 
    <span class="o">=</span> <span class="k">new</span> <span class="nx">Subject</span><span class="o">&lt;</span><span class="nx">ValidationError</span><span class="p">[]</span><span class="o">&gt;</span><span class="p">();</span>

  <span class="c1">// 2 subjects that replays the last value </span>
  <span class="c1">// (ideal for state)</span>
  <span class="k">private</span> <span class="nx">loadingSub$</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReplaySubject</span><span class="o">&lt;</span><span class="nx">boolean</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
  <span class="k">private</span> <span class="nx">actingSub$</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ReplaySubject</span><span class="o">&lt;</span><span class="nx">boolean</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

  <span class="c1">// we don't want to expose the subject for</span>
  <span class="c1">// encapsulation purposes. That's why we convert them</span>
  <span class="c1">// into observables</span>
  <span class="nx">getvalidationErrors$</span> <span class="o">=</span> 
    <span class="k">this</span><span class="p">.</span><span class="nx">validationErrorsSub$</span><span class="p">.</span><span class="nx">asObservable</span><span class="p">();</span>
  <span class="nx">loading$</span> <span class="o">=</span> 
    <span class="k">this</span><span class="p">.</span><span class="nx">loadingSub$</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">distinctUntilChanged</span><span class="p">());</span>
  <span class="nx">acting$</span> <span class="o">=</span> 
    <span class="k">this</span><span class="p">.</span><span class="nx">actingSub$</span><span class="p">.</span><span class="nx">pipe</span><span class="p">(</span><span class="nx">distinctUntilChanged</span><span class="p">());</span>

  <span class="c1">// these are just some regular setters to next </span>
  <span class="c1">// the values in our subjects</span>
  <span class="kd">set</span> <span class="nx">validationErrors</span><span class="p">(</span><span class="nx">errors</span><span class="p">:</span> <span class="nx">ValidationError</span><span class="p">[])</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">validationErrorsSub$</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">errors</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">set</span> <span class="nx">loading</span><span class="p">(</span><span class="nx">val</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">loadingSub$</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kd">set</span> <span class="nx">acting</span><span class="p">(</span><span class="nx">val</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">actingSub$</span><span class="p">.</span><span class="nx">next</span><span class="p">(</span><span class="nx">val</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>So we have a service that basically holds the state of our three statuses.
Now we still have to make sure that the setters of these observables are being called at the right place and the right time.
We don’t want to manually implement that for every call, so let’s create an interceptor for that.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Injectable</span><span class="p">({</span>
    <span class="na">providedIn</span><span class="p">:</span> <span class="dl">'</span><span class="s1">root</span><span class="dl">'</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">HttpStatusInterceptor</span> <span class="k">implements</span> <span class="nx">HttpInterceptor</span> <span class="p">{</span>
  <span class="c1">// keep track of the loading calls</span>
  <span class="k">private</span> <span class="nx">loadingCalls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
  <span class="c1">// keep track of the acting calls</span>
  <span class="k">private</span> <span class="nx">actingCalls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 

  <span class="kd">constructor</span><span class="p">(</span>
    <span class="k">private</span> <span class="nx">httpStatusService</span><span class="p">:</span> <span class="nx">HttpStatusService</span>
  <span class="p">)</span> <span class="p">{}</span>

  <span class="k">private</span> <span class="nx">changeStatus</span><span class="p">(</span><span class="nx">val</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">,</span> <span class="nx">method</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">([</span><span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">PUT</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">DELETE</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">PATCH</span><span class="dl">'</span><span class="p">]</span>
      <span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">val</span> <span class="p">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">actingCalls</span><span class="o">++</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">actingCalls</span><span class="o">--</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">httpStatusService</span><span class="p">.</span><span class="nx">acting</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">actingCalls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">method</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">val</span> <span class="p">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadingCalls</span><span class="o">++</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadingCalls</span><span class="o">--</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">httpStatusService</span><span class="p">.</span><span class="nx">loading</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadingCalls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="p">...</span>
<span class="p">}</span>

</code></pre></div></div>

<p>As we can see, we have created a private <code class="language-plaintext highlighter-rouge">changeStatus()</code> function that will use the <code class="language-plaintext highlighter-rouge">loading</code> and <code class="language-plaintext highlighter-rouge">acting</code> 
setters of our <code class="language-plaintext highlighter-rouge">HttpStatusInterceptor</code> class.</p>

<p>If the HTTP-method is <code class="language-plaintext highlighter-rouge">POST</code>, <code class="language-plaintext highlighter-rouge">PUT</code>, <code class="language-plaintext highlighter-rouge">DELETE</code> or <code class="language-plaintext highlighter-rouge">PATCH</code> we have to update the counter of the <code class="language-plaintext highlighter-rouge">actingCalls</code> and if that count is bigger then 0, it means the user is acting and we have to update the <code class="language-plaintext highlighter-rouge">acting</code> property of the <code class="language-plaintext highlighter-rouge">HttpStatusService</code>.</p>

<p>If the HTTP-method is <code class="language-plaintext highlighter-rouge">GET</code> it should do the same for the <code class="language-plaintext highlighter-rouge">loadingCalls</code> property and <code class="language-plaintext highlighter-rouge">loading</code> setter of the <code class="language-plaintext highlighter-rouge">HttpStatusService</code>.</p>

<p>Of course we still have to implement the <code class="language-plaintext highlighter-rouge">intercept</code> function. Every time we intercept a call we have to change a status to <code class="language-plaintext highlighter-rouge">true</code>.
Because this means that the user is loading or acting.
The goal of an interceptor is to intercept a request, clone that request, do something with it and return it.
The <code class="language-plaintext highlighter-rouge">handle</code> function of the <code class="language-plaintext highlighter-rouge">HttpHandler</code> returns an observable. This is the perfect place to apply a <code class="language-plaintext highlighter-rouge">finalize</code> operator,
which we can use to set a status to <code class="language-plaintext highlighter-rouge">false</code>.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">...</span>
<span class="nx">intercept</span><span class="p">(</span>
  <span class="nx">req</span><span class="p">:</span> <span class="nx">HttpRequest</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">next</span><span class="p">:</span> <span class="nx">HttpHandler</span>
<span class="p">):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">HttpEvent</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
  <span class="c1">// there is a new request, so we are definitely</span>
  <span class="c1">// loading or acting, we have to change the status</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">changeStatus</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">);</span>
  <span class="k">return</span> <span class="nx">next</span><span class="p">.</span><span class="nx">handle</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">clone</span><span class="p">()).</span><span class="nx">pipe</span><span class="p">(</span>
    <span class="c1">// when the request completes, errors or times out,</span>
    <span class="c1">// we have to change the status as well</span>
    <span class="nx">finalize</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">changeStatus</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">);</span>
    <span class="p">})</span>
  <span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div>

<p>This should automatically update the <code class="language-plaintext highlighter-rouge">loading$</code> and <code class="language-plaintext highlighter-rouge">acting$</code> observables in the <code class="language-plaintext highlighter-rouge">HttpStatusService</code>.
However, we have not fixed our validation errors issue yet. For that we can use the <code class="language-plaintext highlighter-rouge">catchError</code> operator that we place before the finalize operator:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">intercept</span><span class="p">(</span>
  <span class="nx">req</span><span class="p">:</span> <span class="nx">HttpRequest</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span><span class="p">,</span>
  <span class="nx">next</span><span class="p">:</span> <span class="nx">HttpHandler</span>
<span class="p">):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">HttpEvent</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
  <span class="p">..</span>
  <span class="k">return</span> <span class="nx">next</span><span class="p">.</span><span class="nx">handle</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">clone</span><span class="p">()).</span><span class="nx">pipe</span><span class="p">(</span>
    <span class="c1">// catch the error</span>
    <span class="nx">catchError</span><span class="p">(</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="c1">// if bad request &gt; validation erors</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">400</span><span class="p">)</span> <span class="p">{</span> 
        <span class="c1">// use the validationErrors setter to update</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">httpStatusService</span><span class="p">.</span><span class="nx">validationErrors</span> <span class="o">=</span> 
          <span class="nx">e</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">validationErrors</span><span class="p">;</span>
        <span class="c1">// make sure that this result never </span>
        <span class="c1">// reaches the component</span>
        <span class="k">return</span> <span class="nx">NEVER</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="c1">// throw the error back</span>
      <span class="c1">// or put that in the `HttpStatusService` as well ;-)      </span>
      <span class="k">return</span> <span class="nx">throwError</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> 
    <span class="p">}),</span>
    <span class="nx">finalize</span><span class="p">(...)</span>
  <span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The entire interceptor class looks like this:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">Injectable</span><span class="p">({</span>
    <span class="na">providedIn</span><span class="p">:</span> <span class="dl">'</span><span class="s1">root</span><span class="dl">'</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">HttpStatusInterceptor</span> <span class="k">implements</span> <span class="nx">HttpInterceptor</span> <span class="p">{</span>
  <span class="k">private</span> <span class="nx">loadingCalls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 
  <span class="k">private</span> <span class="nx">actingCalls</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 

  <span class="kd">constructor</span><span class="p">(</span>
    <span class="k">private</span> <span class="nx">httpStatusService</span><span class="p">:</span> <span class="nx">HttpStatusService</span>
  <span class="p">)</span> <span class="p">{}</span>

  <span class="k">private</span> <span class="nx">changeStatus</span><span class="p">(</span><span class="nx">v</span><span class="p">:</span> <span class="nx">boolean</span><span class="p">,</span> <span class="nx">method</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">([</span><span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">PUT</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">DELETE</span><span class="dl">'</span><span class="p">,</span> <span class="dl">'</span><span class="s1">PATCH</span><span class="dl">'</span><span class="p">]</span>
      <span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">method</span><span class="p">)</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">v</span> <span class="p">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">actingCalls</span><span class="o">++</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">actingCalls</span><span class="o">--</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">httpStatusService</span><span class="p">.</span><span class="nx">acting</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">actingCalls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nx">method</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">GET</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">v</span> <span class="p">?</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadingCalls</span><span class="o">++</span> <span class="p">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadingCalls</span><span class="o">--</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">httpStatusService</span><span class="p">.</span><span class="nx">loading</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">loadingCalls</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="nx">intercept</span><span class="p">(</span>
    <span class="nx">req</span><span class="p">:</span> <span class="nx">HttpRequest</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;</span><span class="p">,</span>
    <span class="nx">next</span><span class="p">:</span> <span class="nx">HttpHandler</span>
  <span class="p">):</span> <span class="nx">Observable</span><span class="o">&lt;</span><span class="nx">HttpEvent</span><span class="o">&lt;</span><span class="kr">any</span><span class="o">&gt;&gt;</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">next</span><span class="p">.</span><span class="nx">handle</span><span class="p">(</span><span class="nx">req</span><span class="p">.</span><span class="nx">clone</span><span class="p">()).</span><span class="nx">pipe</span><span class="p">(</span>
      <span class="nx">catchError</span><span class="p">(</span><span class="nx">e</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">status</span> <span class="o">===</span> <span class="mi">400</span><span class="p">)</span> <span class="p">{</span> 
          <span class="k">this</span><span class="p">.</span><span class="nx">httpStatusService</span><span class="p">.</span><span class="nx">validationErrors</span> <span class="o">=</span> 
            <span class="nx">e</span><span class="p">.</span><span class="nx">error</span><span class="p">.</span><span class="nx">validationErrors</span><span class="p">;</span>
          <span class="k">return</span> <span class="nx">NEVER</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">throwError</span><span class="p">(</span><span class="nx">e</span><span class="p">);</span> 
      <span class="p">}),</span>
      <span class="nx">finalize</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">changeStatus</span><span class="p">(</span><span class="kc">false</span><span class="p">,</span> <span class="nx">req</span><span class="p">.</span><span class="nx">method</span><span class="p">);</span>
      <span class="p">})</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>When registering the interceptor to the root module, the observables in the <code class="language-plaintext highlighter-rouge">HttpStatusService</code> will be updated automatically.</p>

<p>So in the rootModule we have to add the following code to the <code class="language-plaintext highlighter-rouge">providers</code> property of the <code class="language-plaintext highlighter-rouge">@NgModule</code> decorator:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nx">providers</span><span class="p">:</span> <span class="p">[</span>
  <span class="p">...</span>
  <span class="p">{</span>
    <span class="nl">provide</span><span class="p">:</span> <span class="nx">HTTP_INTERCEPTORS</span><span class="p">,</span>
    <span class="nx">multi</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span>
    <span class="nx">deps</span><span class="p">:</span> <span class="p">[</span><span class="nx">HttpStatusService</span><span class="p">],</span>
    <span class="nx">useClass</span><span class="p">:</span> <span class="nx">HttpStatusInterceptor</span>
  <span class="p">}</span>
<span class="p">]</span>
</code></pre></div></div>

<p>We can now use the <code class="language-plaintext highlighter-rouge">HttpStatusService</code> in our code as easy as this:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">class</span> <span class="nx">UserComponent</span> <span class="p">{</span>
  <span class="nx">loading$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">httpStatus</span><span class="p">.</span><span class="nx">loading</span><span class="p">;</span>
  <span class="nx">validationErrors$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">httpStatus</span><span class="p">.</span><span class="nx">validationErrors</span><span class="p">;</span>
  <span class="nx">acting$</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">httpStatus</span><span class="p">.</span><span class="nx">loading</span><span class="p">;</span>

  <span class="kd">constructor</span><span class="p">(</span>
    <span class="k">private</span> <span class="nx">httpStatusService</span><span class="p">:</span> <span class="nx">HttpStatusService</span><span class="p">)</span> <span class="p">{</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>We now have 3 observables that can easily be consumed in the template of the component with the use of the <a href="https://angular.io/api/common/AsyncPipe">async</a> pipe. Here is an example:</p>

<div class="language-html highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;my-spinner</span> <span class="na">*ngIf=</span><span class="s">"loading$ | async"</span><span class="nt">&gt;&lt;/my-spinner&gt;</span>
<span class="nt">&lt;my-user-form</span> 
    <span class="na">[validationErrors]=</span><span class="s">"validationErrors$ | async"</span>
    <span class="na">[disabled]=</span><span class="s">"acting$ | async"</span><span class="nt">&gt;&lt;/my-user-form&gt;</span>

</code></pre></div></div>

<h2 id="optimizing-with-decorators">Optimizing with decorators</h2>

<p>We have cleaned up a lot, we found an easy way to get the httpstatuses to the component, but we can make it even simpler with the use of decorators. let’s refactor the <code class="language-plaintext highlighter-rouge">UserComponent</code> class accordingly:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">class</span> <span class="nx">UserComponent</span> <span class="p">{</span>
  <span class="p">@</span><span class="nd">Loading</span><span class="p">()</span><span class="nx">loading$</span><span class="p">;</span>
  <span class="p">@</span><span class="nd">ValidationErrors</span><span class="p">()</span> <span class="nx">validationErrors$</span><span class="p">;</span>
  <span class="p">@</span><span class="nd">Acting</span><span class="p">()</span> <span class="nx">acting$</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>This is very declarative way of working. The component is way cleaner and we don’t have to inject the <code class="language-plaintext highlighter-rouge">HttpStatusService</code> anymore.</p>

<p>But how do we create these decorators? I’m glad you asked, it’s pretty easy. A property decorator is simply a function that returns a function that gets the target and key as arguments.</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">export</span> <span class="kd">function</span> <span class="nx">Loading</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">target</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">key</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="c1">// in this case the target is the component</span>
    <span class="c1">// instance and key the property name</span>
    <span class="c1">// target: userComponent, key: loading$</span>
    <span class="c1">// now we have to set the property to the actual </span>
    <span class="c1">// loading$ observable that lives in the HttpStatusService</span>
    <span class="nx">target</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="c1">// todo</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<p>To set the property of the target we need to inject the <code class="language-plaintext highlighter-rouge">HttpStatusService</code> instance that is registered on the root injector of our application. After all that’s the instance that contains the actual state. Currently there is no easy way to do that.
Until Angular provides us with functionality like <a href="https://github.com/angular/angular/issues/23301">that</a> we can use the following solution:</p>

<p>Next to the <code class="language-plaintext highlighter-rouge">http-status.service</code> file, create a file called <code class="language-plaintext highlighter-rouge">root-injector.ts</code> and add the following code:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">{</span> <span class="nx">Injector</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">@angular/core</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">let</span> <span class="nx">rootInjector</span><span class="p">:</span> <span class="nx">Injector</span><span class="p">;</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">setRootInjector</span><span class="p">(</span><span class="nx">injector</span><span class="p">:</span> <span class="nx">Injector</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
  <span class="nx">rootInjector</span> <span class="o">=</span> <span class="nx">injector</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">setRootInjector()</code> function will be used by the rootModule to set the <code class="language-plaintext highlighter-rouge">rootInjector</code> variable that we expose here.
To make it work the rootModule will have to call the <code class="language-plaintext highlighter-rouge">setRootInjector()</code> function like this:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">@</span><span class="nd">NgModule</span><span class="p">({</span>
    <span class="p">...</span>
<span class="p">})</span>
<span class="k">export</span> <span class="kd">class</span> <span class="nx">AppModule</span> <span class="p">{</span>
  <span class="kd">constructor</span><span class="p">(</span><span class="k">private</span> <span class="nx">injector</span><span class="p">:</span> <span class="nx">Injector</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">setRootInjector</span><span class="p">(</span><span class="nx">injector</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>

</code></pre></div></div>

<p>The last step is to actually use the <code class="language-plaintext highlighter-rouge">rootInjector</code> variable inside the decorators. The result looks like this:</p>

<div class="language-typescript highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// loading.decorator.ts</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">Loading</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">target</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">key</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">service</span> <span class="o">=</span> <span class="nx">rootInjector</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">HttpStatusService</span><span class="p">);</span>
    <span class="nx">target</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">service</span><span class="p">.</span><span class="nx">loading$</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// acting.decorator.ts</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">Acting</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">target</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">key</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">service</span> <span class="o">=</span> <span class="nx">rootInjector</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">HttpStatusService</span><span class="p">);</span>
    <span class="nx">target</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">service</span><span class="p">.</span><span class="nx">acting$</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>

<span class="c1">// validation-errors.decorator.ts</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nx">ValidationErrors</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">return</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">target</span><span class="p">:</span> <span class="kr">any</span><span class="p">,</span> <span class="nx">key</span><span class="p">:</span> <span class="kr">string</span><span class="p">):</span> <span class="k">void</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">service</span> <span class="o">=</span> <span class="nx">rootInjector</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">HttpStatusService</span><span class="p">);</span>
    <span class="nx">target</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">service</span><span class="p">.</span><span class="nx">validationErrors$</span><span class="p">;</span>
  <span class="p">}</span>
<span class="p">};</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>We have learned that we can remove the redundancy that comes with loading, acting and error handling statuses almost completely by the use of an interceptor, a simple service and a few decorators.</p>

<p>I hope you liked it!</p>

<h2 id="special-thanks">Special thanks</h2>

<p>A very special thanks to the reviewers:</p>

<ul>
  <li><a href="https://twitter.com/bobrov1989">Vitallii Bobrov (@bobrov1989)</a></li>
  <li><a href="https://twitter.com/webdave_de">David Müllerchen (@webdave_de)</a></li>
  <li><a href="https://twitter.com/maartentibau">Maarten Tibau (@maartentibau)</a></li>
  <li><a href="https://twitter.com/elmd_">Dominic Elm (@elmd_)</a></li>
  <li><a href="https://twitter.com/fabiangosebrink">Fabian Gosebrink (@FabianGosebrink)</a></li>
</ul>

  </div><a class="u-url" href="/generic-way-of-handling-loading-saving-and-validationerrors-in-angular/" hidden></a>
</article>

                        </div>
                        <div class="page__wrapper-right">
                            <div class="profile">
                                <img src="/assets/images/angular.png" alt="Author image" nopin="nopin"/>
                                <h3>Angular Best Practices Training</h3>
                                <p>6 Years of international experience (50+ projects) in one day.</p>
                                <a class="hire-me-button" href="https://brecht.io/angular-best-practices-training">Learn more now</a>
                            </div>
                        </div>
                    </div>
                </div>


            </main>
        </div><div class="footer">
    <div class="page__wrapper">
        <p>Nflow BV - Provinciebaan 120,9270 Laarne</p>
        <ul class="footer__social-icons">
            <li>
                <a href="https://www.linkedin.com/in/brecht-billiet-58417426/" target="blank"
                   class="footer__social-icon">
                    <i class="fa-brands fa-linkedin"></i>
                </a>
            </li>
            <li>
                <a href="https://twitter.com/brechtbilliet" target="blank" class="footer__social-icon">
                    <i class="fa-brands fa-twitter"></i>
                </a>
            </li>
            <li>
                <a href="mailto:billietbrecht@gmail.com" target="blank" class="footer__social-icon">
                    <i class="fa-solid fa-envelope-open"></i>
                </a>
            </li>
        </ul>
        <a href="#" id="open_preferences_center">Change your preferences</a>
    </div>
</div>
</div>
</section>
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-43296458-4"></script>
<script type="text/javascript" src="//www.privacypolicies.com/public/cookie-consent/4.0.0/cookie-consent.js"
        charset="UTF-8"></script>
<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        cookieconsent.run({
            "notice_banner_type": "simple",
            "consent_type": "implied",
            "palette": "light",
            "language": "en",
            "page_load_consent_levels": ["strictly-necessary", "functionality", "tracking", "targeting"],
            "notice_banner_reject_button_hide": false,
            "preferences_center_close_button_hide": false,
            "page_refresh_confirmation_buttons": false,
            "website_name": "brecht.io"
        });
    });
</script>
<script cookie-consent="tracking">
    window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }

    gtag('js', new Date());

    gtag('config', 'UA-43296458-4');
</script>
<script lang="text/javascript">
    window.menuCollapsed = true;
    const appMenu = document.querySelector('.app__menu');
    const closeButton = document.querySelector('.app__menu-close-btn');
    document.querySelector('#menu-button').addEventListener('click', () => {
        window.menuCollapsed = !window.menuCollapsed;
        console.log(window.menuCollapsed);
        if (!window.menuCollapsed) {
            appMenu.classList.add('app__menu--open')
        } else {
            appMenu.classList.remove('app__menu--open')
        }
    })
    closeButton.addEventListener('click', () => {
        window.menuCollapsed = true;
        appMenu.classList.remove('app__menu--open')
    })

</script>
<noscript>Cookie Consent by <a href="https://www.privacypolicies.com/" rel="noopener">Privacy Policies Generator
    website</a></noscript>
</body>

</html>
